/*
 * Copyright 2013 Baidu Inc. All rights reserved.
 *
 * file:    another form validator based on the struts2 framework.
 * author:  Liu,Ronghan(liuronghan@baidu.com)
 * date:    2013/09/28
 * repos:   https://github.com/mycoin/validation
 */
(function(global,factory){typeof define==="function"&&define(factory);(typeof exports!=="undefined"?exports:global).validator=factory()}(this,function(){var exports={version:"stable-1.0.1"};var OK=true;function trim(source){source=(""+source).replace(/^\s+/,"");for(var i=source.length-1;i>=0;i--){if(/\S/.test(source.charAt(i))){source=source.substring(0,i+1);break}}return source}function restore(value,optValue){if(value===""||value===undefined||value===null){value=optValue}return value}function parseDate(source){var ret=source;if(ret=Date.parse(source)){return new Date(ret)}ret=source;if(/^[0-9\-\/\ :]*$/.test(ret)){ret=ret.replace(/\-/g,"/");if(ret=new Date(ret)){return ret}}return false}function assert(condition,optMessage){if(!condition){var msg="Assertion failed";if(optMessage){msg=msg+": "+optMessage}throw new Error(msg)}}var validators={"required":function(rule,value){value=restore(value,null);return value===null?rule.message:OK},"requiredstring":function(rule,value){value=restore(value,"");rule.trim===true&&(value=trim(value));return value.length===0?rule.message:OK},"int":function(rule,value){value=restore(value,null);if(value===null){return true}if(!/^\-?[0-9]+$/.test(value)){return rule.message}else{value=parseInt(value)}var min=parseInt(rule.min);var max=parseInt(rule.max);if(!isNaN(min)&&value-min<0){return rule.message}if(!isNaN(max)&&value-max>0){return rule.message}return OK},"long":function(rule,value){return validators["int"].call(this,rule,value)},"double":function(rule,value){value=restore(value,null);if(value===null){return OK}if(!/^\-?[0-9]*\.?[0-9]+$/.test(value)){return rule.message}else{value=parseFloat(value)}var maxInclusive=parseFloat(rule.maxInclusive);var minInclusive=parseFloat(rule.minInclusive);var maxExclusive=parseFloat(rule.maxExclusive);var minExclusive=parseFloat(rule.minExclusive);if((!isNaN(maxInclusive)&&value-maxInclusive>0)||(!isNaN(minInclusive)&&value-minInclusive<0)||(!isNaN(maxExclusive)&&value-maxExclusive>=0)||(!isNaN(minExclusive)&&value-minExclusive<=0)){return rule.message}return OK},"date":function(rule,value){value=restore(value,null);if(value===null){return OK}value=parseDate(value);if(!value||"Invalid Date"===value){return rule.message}var min=parseDate(rule.min);var max=parseDate(rule.max);if(!isNaN(min)&&value.getTime()-min.getTime()<0){return rule.message}if(!isNaN(max)&&value.getTime()-max.getTime()>0){return rule.message}return OK},"email":function(rule,value){rule.caseSensitive=false;rule.expression=""+"\\b"+"^[_A-Za-z0-9-]+(.[_A-Za-z0-9-]+)*@([A-Za-z0-9-])+"+"(.[A-Za-z0-9-]+)*((.[A-Za-z0-9]{2,})|(.[A-Za-z0-9]{2,}"+".[A-Za-z0-9]{2,}))$";return validators.regex.call(this,rule,value)},"regex":function(rule,value){value=restore(value,null);if(value===null||trim(value).length===0){return OK}undefined===rule.caseSensitive&&(rule.caseSensitive=true);undefined===rule.trim&&(rule.trim=true);rule.trim===true&&(value=trim(value));var opt=rule.caseSensitive?"i":undefined;try{if(!new RegExp(rule.expression,opt).test(value)){return rule.message}}catch(ex){}return OK},"url":function(rule,value){return OK},"stringlength":function(rule,value){value=restore(value,null);if(value===null||value.length<=0){return OK}undefined===rule.minLength&&(rule.minLength=-1);undefined===rule.maxLength&&(rule.maxLength=-1);undefined===rule.trim&&(rule.trim=true);if(rule.trim===true){value=trim(value)}if((rule.minLength>-1)&&(value.length<rule.minLength)){return rule.message}else{if((rule.minLength>-1)&&(value.length>rule.minLength)){return rule.message}}return OK}};exports.validate=function(collection,rules){var stacks=[];for(var key in rules||{}){for(var name in rules[key]||{}){var rule=rules[key][name]||{};var func=validators[name];if(typeof func==="function"){var message=func(rule,collection[key],collection);if(message!==OK){stacks.push({field:key,message:message,value:collection[key]})}}else{assert(false,"Validator `"+name+"` not found.")}}}return stacks.length?{"result":false,"field":stacks[0].field,"message":stacks[0].message,"stacks":stacks}:{"result":true,"message":"OK"}};exports.validateSync=function(){var me=this;var argv=[].slice.call(arguments,0);setTimeout(function(){exports.validate.apply(me,argv)},0)};return exports}));